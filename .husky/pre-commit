#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ğŸ¢âš¡ Energy Optimizer Pro - Pre-commit Hook
# ===========================================

echo "ğŸ” Running pre-commit checks..."

# Frontend checks
echo "ğŸ“¦ Checking frontend..."
cd frontend

# Run linting
npm run lint || {
  echo "âŒ Frontend linting failed!"
  exit 1
}

# Run type checking
npm run type-check || {
  echo "âŒ Frontend type checking failed!"
  exit 1
}

# Run tests (quick)
npm run test:ci || {
  echo "âŒ Frontend tests failed!"
  exit 1
}

cd ..

# Backend checks
echo "ğŸ Checking backend..."
cd backend

# Activate virtual environment
if [ -f "venv/bin/activate" ]; then
  source venv/bin/activate
elif [ -f "venv/Scripts/activate" ]; then
  source venv/Scripts/activate
fi

# Run linting
flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || {
  echo "âŒ Backend linting failed!"
  exit 1
}

# Check code formatting
black --check . || {
  echo "âŒ Backend code formatting failed!"
  echo "ğŸ’¡ Run: cd backend && black ."
  exit 1
}

# Check import sorting
isort --check-only . || {
  echo "âŒ Backend import sorting failed!"
  echo "ğŸ’¡ Run: cd backend && isort ."
  exit 1
}

# Run type checking
mypy app/ --ignore-missing-imports || {
  echo "âš ï¸ Backend type checking has warnings"
  # Don't fail on mypy warnings, just warn
}

# Run quick tests
python -m pytest tests/ -x --tb=short || {
  echo "âŒ Backend tests failed!"
  exit 1
}

cd ..

echo "âœ… All pre-commit checks passed!"
